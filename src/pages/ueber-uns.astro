---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import CTA from "../components/CTA.astro";
import { getAboutPageContent, getTeamVoices } from "../data/cms";

const [teamVoices, aboutPage] = await Promise.all([getTeamVoices(), getAboutPageContent()]);
const teamImageUrl = aboutPage?.teamImage;
const teamImageAlt = aboutPage?.teamImageAlt ?? 'Team des Repair Café Leonberg';
const teamImageTitle = aboutPage?.teamImageTitle ?? 'Teamgeist';
const teamImageDescription =
  aboutPage?.teamImageDescription ?? 'Gemeinsam stark fürs Reparieren – das Team des Repair Café Leonberg.';
const missionParagraphs = aboutPage?.missionParagraphs ?? [];
const hasTeamVoices = teamVoices && teamVoices.length > 0;
---

<BaseLayout title="Über uns – Repair Café Leonberg" description="Erfahre mehr über das Team und die Vision hinter dem Repair Café Leonberg.">
  <Header />

  <main class="bg-slate-100 py-12 md:py-16">
    <section class="pb-12">
      <div class="container">
        <div class="mx-auto max-w-4xl text-center">
          <span class="inline-flex items-center gap-2 rounded-full bg-white px-4 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">
            Über uns
          </span>
          <h1 class="mt-5 heading-hero">
            Gemeinsam reparieren, voneinander lernen
          </h1>
          <p class="mt-3 text-base text-slate-600">
            Gemeinsam für Nachhaltigkeit, Nachbarschaft und Müllvermeidung.
          </p>
        </div>
      </div>
    </section>

    {teamImageUrl && (
      <div
        id="team-photo-modal"
        class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 p-4 backdrop-blur transition duration-300"
        aria-hidden="true"
      >
        <div data-team-photo-overlay class="absolute inset-0"></div>
        <div class="relative z-10 w-full max-w-5xl">
          <button
            type="button"
            data-team-photo-close
            class="absolute -right-3 -top-3 inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/90 text-slate-800 shadow-lg shadow-slate-900/30 transition hover:-translate-y-0.5 hover:bg-white"
            aria-label="Teamfoto schließen"
          >
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 6l12 12M6 18 18 6" />
            </svg>
          </button>
          <div class="overflow-hidden rounded-[2.5rem] border border-white/10 bg-slate-900/80 shadow-2xl shadow-slate-950/60">
            <img src={teamImageUrl} alt={teamImageAlt} class="h-full w-full object-contain" loading="lazy" />
          </div>
        </div>
      </div>
    )}

    <section class="pb-12">
      <div class="container">
        <div class="grid gap-8 lg:grid-cols-2 lg:items-center">
          <div class="relative overflow-hidden rounded-[32px] bg-white/90 shadow-xl shadow-slate-900/10">
            <div class="relative aspect-[4/3] w-full">
              {teamImageUrl ? (
                <button
                  type="button"
                  class="group relative block h-full w-full text-left focus:outline-none"
                  data-team-photo-trigger
                  aria-label="Teamfoto vergrößern"
                >
                  <img src={teamImageUrl} alt={teamImageAlt} loading="lazy" class="h-full w-full object-cover" />
                  <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-slate-950/65 via-slate-900/10 to-transparent transition duration-300 group-hover:opacity-95"></div>
                  <div class="absolute bottom-4 left-4 flex max-w-sm flex-col gap-2 text-white drop-shadow-[0_6px_20px_rgba(0,0,0,0.45)]">
                    <span class="inline-flex w-fit items-center gap-2 rounded-full border border-white/30 px-4 py-1 text-xs uppercase tracking-[0.3em]">
                      {teamImageTitle}
                    </span>
                    <p class="text-base font-semibold leading-relaxed">
                      {teamImageDescription}
                    </p>
                  </div>
                </button>
              ) : (
                <>
                  <div class="absolute inset-0 bg-gradient-to-br from-slate-200 via-slate-400 to-slate-600"></div>
                  <div class="absolute inset-0 flex flex-col items-center justify-center gap-3 bg-slate-900/70 text-center text-white">
                    <span class="rounded-full border border-white/30 px-4 py-1 text-xs uppercase tracking-[0.32em]">{teamImageTitle}</span>
                    <p class="max-w-sm text-lg font-semibold">
                      {teamImageDescription}
                    </p>
                  </div>
                </>
              )}
            </div>
          </div>

          <div class="rounded-3xl bg-white p-8 shadow-lg shadow-slate-900/5 space-y-4 text-sm text-slate-600">
            <p>
              Unter dem Motto „Wegwerfen? Denkste!“ setzen wir uns gegen die Wegwerfgesellschaft ein. Unser Ziel: Reparieren statt neu kaufen, Müll vermeiden, Ressourcen schonen und CO₂ sparen.
            </p>
            <p>
              Wir sind keine Dienstleister, sondern leben „Hilfe zur Selbsthilfe“: Wir reparieren mit Ihnen, teilen Wissen und stärken die Freude am eigenen Können. Unser Treffpunkt ist offen, tolerant und lädt bei Kaffee und Kuchen zum Austausch ein.
            </p>
            <p>
              Das Repair Café wurde 2015 von Dr. Eckart Matthias gegründet. Aus einer kleinen Tüftlergruppe ist eine feste Institution geworden, die bereits Hunderte Gegenstände vor der Tonne bewahrt und Nachhaltigkeit in Leonberg sichtbar macht. Als Arbeitsgruppe der Lokalen Agenda 21 Leonberg arbeiten wir eng mit weiteren Initiativen für ein lebenswertes Leonberg zusammen.
            </p>
            <figure class="mx-auto w-40 max-w-full overflow-hidden rounded-2xl border border-slate-200 bg-slate-50 shadow-sm shadow-slate-900/10 dark:border-slate-700/60 dark:bg-slate-900/60">
              <img
                src="/lokaleagenda21.jpg"
                alt="Logo der Lokalen Agenda 21 Leonberg"
                class="mx-auto h-full w-full object-contain"
                loading="lazy"
              />
            </figure>
          </div>
        </div>
      </div>
    </section>

    {hasTeamVoices && (
      <section class="pb-12">
        <div class="bg-gradient-to-br from-brand-900 via-brand-800 to-slate-900 py-12 shadow-inner shadow-black/30">
          <div class="container text-white">
            <div class="mx-auto max-w-3xl text-center">
              <span class="inline-flex items-center gap-2 rounded-full bg-white/10 px-4 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-white/80 ring-1 ring-white/20">
                Teamstimmen
              </span>
              <h2 class="mt-4 heading-section text-white">Warum wir dabei sind</h2>
              <p class="mt-2 text-sm text-white/80">
                Menschen aus dem Team erzählen, warum sie mitmachen – vielleicht motiviert es auch Sie.
              </p>
            </div>

            <div class="mt-10 relative" data-team-slider>
              <div class="flex items-center justify-between gap-4 pb-4">
                <div class="flex items-center gap-2 text-white/80 text-xs uppercase tracking-[0.2em]">
                  <span class="h-px w-8 bg-white/40"></span>
                  Teammitglieder erzählen
                </div>
                {teamVoices.length > 1 && (
                  <div class="flex items-center gap-2">
                    <button type="button" aria-label="Vorheriger Beitrag" data-team-prev class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/30 bg-white/10 text-white shadow-sm transition hover:-translate-y-0.5 hover:border-white/60 hover:bg-white/15">
                      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6" /></svg>
                    </button>
                    <button type="button" aria-label="Nächster Beitrag" data-team-next class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/30 bg-white/10 text-white shadow-sm transition hover:-translate-y-0.5 hover:border-white/60 hover:bg-white/15">
                      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 6l6 6-6 6" /></svg>
                    </button>
                  </div>
                )}
              </div>

              <div class="overflow-hidden" data-team-viewport>
                <div class="flex gap-6 transition-transform duration-500 ease-out" data-team-track>
                  {teamVoices.map((voice) => (
                    <article class="min-w-0 shrink-0 grow-0 basis-full rounded-[28px] bg-white/10 p-6 text-left shadow-2xl shadow-black/30 ring-1 ring-white/10 md:p-8">
                      <div class="flex flex-col gap-6 md:flex-row md:items-start md:gap-8">
                        <div class="relative h-48 w-48 overflow-hidden rounded-[32px] bg-white/15 ring-1 ring-white/20 md:h-56 md:w-56 lg:h-64 lg:w-64">
                          {voice.portrait ? (
                            <img src={voice.portrait} alt={voice.portraitAlt ?? `${voice.name} Portrait`} class="h-full w-full object-cover" loading="lazy" />
                          ) : (
                            <div class="flex h-full w-full items-center justify-center text-base font-semibold text-white/70">RC</div>
                          )}
                        </div>
                        <div class="flex flex-1 flex-col gap-4 md:pt-1">
                          <div class="md:pt-1">
                            <p class="text-xl font-semibold text-white md:text-2xl">{voice.name}</p>
                            {voice.role && <p class="text-sm text-white/70 md:text-base">{voice.role}</p>}
                          </div>
                          <div class="relative flex flex-1 items-center rounded-3xl bg-white/10 p-6 text-white shadow-inner shadow-white/10 ring-1 ring-white/10 md:p-7 lg:p-8">
                            <span class="absolute -left-3 -top-2 text-5xl font-black text-white/20">“</span>
                            <p class="relative z-[1] text-base leading-relaxed md:text-lg">{voice.quote}</p>
                          </div>
                        </div>
                      </div>
                    </article>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    )}

    {teamImageUrl && (
      <script is:inline>
        (() => {
          const modal = document.getElementById('team-photo-modal');
          if (!modal) return;

          const openers = document.querySelectorAll('[data-team-photo-trigger]');
          const closeButton = modal.querySelector('[data-team-photo-close]');
          const overlay = modal.querySelector('[data-team-photo-overlay]');

          const open = () => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
          };

          const close = () => {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
            modal.setAttribute('aria-hidden', 'true');
            document.body.style.removeProperty('overflow');
          };

          openers.forEach((trigger) => {
            trigger.addEventListener('click', open);
          });

          closeButton?.addEventListener('click', close);
          overlay?.addEventListener('click', close);

          window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') {
              close();
            }
          });
        })();
      </script>
    )}
  </main>

  <CTA />
  <Footer />
</BaseLayout>

{hasTeamVoices && (
  <script is:inline>
    (() => {
      const slider = document.querySelector('[data-team-slider]');
      if (!slider) return;
      const track = slider.querySelector('[data-team-track]');
      const slides = Array.from(track?.children ?? []);
      const prev = slider.querySelector('[data-team-prev]');
      const next = slider.querySelector('[data-team-next]');
      if (!track || slides.length === 0) return;

      let index = 0;

      const update = () => {
        const slideWidth = slides[0]?.getBoundingClientRect().width || 0;
        const gap = parseFloat(getComputedStyle(track).columnGap || getComputedStyle(track).gap || '24') || 24;
        track.style.transform = `translateX(${-index * (slideWidth + gap)}px)`;
      };

      prev?.addEventListener('click', () => {
        index = (index - 1 + slides.length) % slides.length;
        update();
      });
      next?.addEventListener('click', () => {
        index = (index + 1) % slides.length;
        update();
      });

      window.addEventListener('resize', update);
      update();
    })();
  </script>
)}
