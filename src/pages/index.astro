---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import NextEventBanner from "../components/NextEventBanner.astro";
import Footer from "../components/Footer.astro";
import Hero from "../components/Hero.astro";
import FAQ from "../components/FAQ.astro";
import CTA from "../components/CTA.astro";
import RepairCategoryIcon from "../components/RepairCategoryIcon";
import {
  getUpcomingEvents,
  getAllEvents,
  getPosts,
  getGalleryImages,
  getHeroSlides,
  getGuestbookEntries,
} from "../data/cms";

export const prerender = false;

const [
  upcomingEvents,
  allEvents,
  latestPosts,
  galleryImages,
  heroSlides,
  guestbookEntries,
] = await Promise.all([
  getUpcomingEvents(),
  getAllEvents(),
  getPosts(),
  getGalleryImages(),
  getHeroSlides(),
  getGuestbookEntries(),
]);

const parseEventDate = (eventDate?: string) => {
  if (!eventDate) return null;
  const [year, month, day] = eventDate.split("-").map(Number);
  if (!year || !month || !day) return null;
  return new Date(Date.UTC(year, month - 1, day, 23, 59, 59, 999));
};

const now = new Date();

const ensureUpcomingEvent = (...collections: Array<typeof upcomingEvents>) => {
  for (const events of collections) {
    const match = events.find((event) => {
      const eventDate = parseEventDate(event?.date);
      return eventDate ? eventDate.getTime() >= now.getTime() : false;
    });
    if (match) return match;
  }
  return undefined;
};

const nextEvent = ensureUpcomingEvent(upcomingEvents, allEvents);
const normaliseWhitespace = (value: string) =>
  value.replace(/\s+/g, " ").trim();

const bodyToPlainText = (body: any[] | undefined) => {
  if (!Array.isArray(body)) return "";
  return body
    .map((slice) => {
      if (slice?._type === "block" && Array.isArray(slice.children)) {
        return slice.children.map((child: any) => child?.text ?? "").join("");
      }
      if (slice?._type === "image" && typeof slice?.alt === "string") {
        return slice.alt;
      }
      return "";
    })
    .join(" ")
    .replace(/\s+/g, " ")
    .trim();
};

const createPreview = (text: string, limit = 200) => {
  const base = normaliseWhitespace(text);
  if (!base) return "";
  if (base.length <= limit) return base;
  const clipped = base.slice(0, limit);
  const lastSpace = clipped.lastIndexOf(" ");
  const safeClip = lastSpace > 0 ? clipped.slice(0, lastSpace) : clipped;
  return `${safeClip.trim()}…`;
};

const shuffleSlides = <T,>(collection: T[] = []) => {
  const arr = [...collection];
  for (let i = arr.length - 1; i > 0; i -= 1) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
};

const randomizedHeroSlides = shuffleSlides(heroSlides);

const posts = latestPosts.map((post) => {
  const plain =
    post.bodyPlain && post.bodyPlain.trim().length > 0
      ? post.bodyPlain
      : bodyToPlainText(post.body);
  return { ...post, preview: createPreview(plain ?? "") };
});

const repairCategories = [
  {
    title: "Elektro",
    desc: "Mixer, Lampen, Staubsauger, Radios, Toaster…",
    icon: "electronics",
  },
  {
    title: "Textil",
    desc: "Kleinere Näharbeiten, Löcher stopfen, Knöpfe annähen…",
    icon: "textile",
  },
  {
    title: "Fahrrad",
    desc: "Bremsen einstellen, Licht reparieren, Reifen flicken…",
    icon: "bike",
  },
  {
    title: "Holz & Spielzeug",
    desc: "Geleimte Stühle, defektes Holzspielzeug…",
    icon: "wood",
  },
  {
    title: "Computer/Handy",
    desc: "Einfache Einrichtung, Updates, kleine Fehleranalyse.",
    icon: "software",
  },
  {
    title: "Unsicher?",
    desc: "Schreiben Sie uns kurz, dann prüfen wir, ob Ihr Gerät passt.",
    icon: "contact",
    href: "/kontakt",
  },
];

const highlightGallery = galleryImages
  .filter((item) => item.image)
  .filter((item) => item.layout !== "wide")
  .slice(0, 8);

const guestbookHighlights = guestbookEntries.slice(0, 8);
---

<BaseLayout
  title="Repair Café Leonberg – Reparieren statt Wegwerfen"
  description="Reparieren statt Wegwerfen – gemeinsam nachhaltiger in Leonberg. Kostenlos, ehrenamtlich und offen für alle."
>
  <Header />
  <NextEventBanner event={nextEvent} ctaHref="/termine" />
  <Hero ctaHref="/termine" heroImages={randomizedHeroSlides} />

  <section id="angebote" class="mt-16 md:mt-24">
    <div class="container">
      <div class="mx-auto max-w-3xl text-center">
        <h2 class="heading-section">Was wir reparieren</h2>
        <p class="mt-3 text-slate-700 dark:text-slate-300">
          Vom Wackelkontakt bis zum kaputten Reißverschluss – unsere Experten
          helfen Ihnen bei vielfältigen Defekten.
        </p>
      </div>
      <div class="mt-10 grid gap-5 sm:grid-cols-2 lg:grid-cols-3">
        {
          repairCategories.map((item) => (
            <article class="glass rounded-2xl p-6 transition hover:-translate-y-1 hover:shadow-xl">
              <div class="flex items-start gap-4">
                <span class="flex h-12 w-12 flex-none items-center justify-center rounded-2xl bg-white/80 text-brand-600 shadow-sm shadow-brand-600/20 dark:bg-slate-900/70">
                  <RepairCategoryIcon icon={item.icon} client:load />
                </span>
                <div>
                  <h3 class="card-title">{item.title}</h3>
                  <p class="mt-2 body-text">{item.desc}</p>
                  {item.href && (
                    <a
                      class="mt-3 inline-flex items-center gap-1 text-sm font-semibold text-brand-700 hover:underline"
                      href={item.href}
                    >
                      Kontakt aufnehmen
                      <svg
                        class="h-4 w-4"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path d="M5 12h14M13 5l7 7-7 7" />
                      </svg>
                    </a>
                  )}
                </div>
              </div>
            </article>
          ))
        }
      </div>
    </div>
  </section>

  <script is:inline>
    (() => {
      const slider = document.querySelector("[data-guestbook-slider]");
      const track = slider?.querySelector("[data-guestbook-track]");
      const prev = document.querySelector("[data-guestbook-prev]");
      const next = document.querySelector("[data-guestbook-next]");
      if (!slider || !track) return;

      let index = 0;
      const cards = Array.from(track.querySelectorAll("article"));
      if (!cards.length) return;

      const getGap = () => {
        const styles = getComputedStyle(track);
        const gapVal = styles.gap || "0";
        const parsed = parseFloat(gapVal);
        return Number.isFinite(parsed) ? parsed : 0;
      };

      const cardWidth = () => cards[0].getBoundingClientRect().width + getGap();
      const visibleCount = () => {
        const width = slider.getBoundingClientRect().width;
        const cw = cardWidth();
        return Math.max(1, Math.round((width + getGap()) / cw));
      };

      const clampIndex = () => {
        const max = Math.max(0, cards.length - visibleCount());
        index = Math.min(Math.max(0, index), max);
      };

      const update = () => {
        clampIndex();
        const offset = -index * cardWidth();
        track.setAttribute("style", `transform: translateX(${offset}px);`);
      };

      prev?.addEventListener("click", () => {
        index -= 1;
        update();
      });
      next?.addEventListener("click", () => {
        index += 1;
        update();
      });

      window.addEventListener("resize", () => {
        update();
      });

      update();
    })();
  </script>

  <section id="aktuelles" class="mt-16 md:mt-24">
    <div class="container">
      <div class="mx-auto max-w-3xl text-center">
        <h2 class="heading-section">Neuigkeiten aus dem RepairCafé</h2>
        <p class="mt-3 text-slate-700 dark:text-slate-300">
          Erfolgsgeschichten, Termine und Updates rund um unsere Initiative in
          Leonberg.
        </p>
      </div>
      <div class="mt-10 grid gap-8 md:grid-cols-2 xl:grid-cols-3">
        {
          [...posts]
            .sort((a, b) => (a.date < b.date ? 1 : -1))
            .slice(0, 3)
            .map((post) => (
              <article class="group flex h-full flex-col overflow-hidden rounded-3xl bg-white shadow-lg shadow-slate-900/5 transition hover:-translate-y-1 hover:shadow-xl">
                {post.coverImage && (
                  <a
                    href={post.slug ? `/aktuelles/${post.slug}` : "/aktuelles"}
                    class="relative aspect-[16/10] overflow-hidden bg-slate-200 block group-hover:opacity-90 transition-opacity"
                  >
                    <img
                      src={post.coverImage}
                      alt={post.title}
                      class="h-full w-full object-cover transition duration-500 group-hover:scale-105"
                      loading="lazy"
                    />
                  </a>
                )}
                <div class="flex flex-1 flex-col gap-5 px-6 py-6">
                  <div class="space-y-2">
                    <time
                      datetime={post.publishedAt ?? ""}
                      class="text-xs font-semibold uppercase tracking-[0.2em] text-brand-600"
                    >
                      {post.publishedAt
                        ? new Intl.DateTimeFormat("de-DE", {
                            day: "2-digit",
                            month: "long",
                            year: "numeric",
                          }).format(new Date(post.publishedAt))
                        : "Datum folgt"}
                    </time>
                    <h3 class="card-title">
                      <a
                        href={
                          post.slug ? `/aktuelles/${post.slug}` : "/aktuelles"
                        }
                        class="hover:text-brand-600 transition-colors"
                      >
                        {post.title}
                      </a>
                    </h3>
                    {post.preview && (
                      <p class="text-sm text-slate-600">{post.preview}</p>
                    )}
                  </div>
                  {post.tags && post.tags.length > 0 && (
                    <div class="flex flex-wrap gap-2">
                      {post.tags.map((tag) => (
                        <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}
                  <div class="mt-auto pt-4">
                    <a
                      href={
                        post.slug ? `/aktuelles/${post.slug}` : "/aktuelles"
                      }
                      class="inline-flex items-center gap-2 text-sm font-semibold text-brand-600"
                    >
                      Mehr erfahren
                      <svg
                        class="h-4 w-4"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path d="M5 12h14M13 5l7 7-7 7" />
                      </svg>
                    </a>
                  </div>
                </div>
              </article>
            ))
        }
      </div>
      <div class="mt-12 text-center">
        <a
          href="/aktuelles"
          class="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-5 py-3 text-sm font-semibold text-slate-800 shadow-sm transition hover:-translate-y-0.5 hover:bg-slate-50"
        >
          Alle Beiträge ansehen
        </a>
      </div>
    </div>
  </section>

  <section id="so-gehts" class="mt-16 md:mt-24">
    <div class="container">
      <div class="mx-auto max-w-3xl text-center">
        <h2 class="heading-section">So funktioniert’s</h2>
        <p class="mt-3 text-slate-700 dark:text-slate-300">
          Schritt für Schritt erklärt: So läuft Ihr Besuch bei uns ab – vom
          Empfang bis zur erfolgreichen Reparatur.
        </p>
      </div>
      <ol class="mt-10 grid gap-5 list-none md:grid-cols-4">
        {
          [
            {
              step: "1",
              title: "Ankommen & anmelden",
              desc: "Kurz am Empfang einchecken, Laufzettel ausfüllen, passenden Experten finden.",
            },
            {
              step: "2",
              title: "Experten-Check",
              desc: "Direkt zum Fach-Tisch, Diagnose besprechen und Vorgehen planen.",
            },
            {
              step: "3",
              title: "Gemeinsam reparieren",
              desc: "Unter Anleitung selbst mit anpacken – Hilfe zur Selbsthilfe.",
            },
            {
              step: "4",
              title: "Freuen & spenden",
              desc: "Bei Erfolg anstoßen, Kaffee genießen, Spende fürs Werkzeug-Schwein da lassen.",
            },
          ].map((s) => (
            <li class="glass rounded-2xl p-6">
              <div class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-brand-600/10 font-semibold text-brand-700 dark:text-brand-300">
                {s.step}
              </div>
              <h3 class="mt-3 font-semibold text-slate-900 dark:text-white">
                {s.title}
              </h3>
              <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">
                {s.desc}
              </p>
            </li>
          ))
        }
      </ol>
    </div>
  </section>

  <section id="stimmen" class="mt-16 md:mt-24">
    <div class="container">
      <div class="mx-auto max-w-3xl text-center">
        <h2 class="heading-section">Das sagen unsere Gäste</h2>
        <p class="mt-3 text-slate-700 dark:text-slate-300">
          Feedback, das uns motiviert.
        </p>
      </div>
      <div class="mt-8 space-y-4">
        <div
          class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between"
        >
          <a
            href="/gaestebuch"
            class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-600 transition hover:text-brand-700"
          >
            Schreiben Sie in unser Gästebuch
          </a>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
              <button
                type="button"
                aria-label="Vorheriger Eintrag"
                data-guestbook-prev
                class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 bg-white text-slate-700 shadow-sm transition hover:-translate-y-0.5 hover:border-brand-500 hover:text-brand-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500"
              >
                <svg
                  class="h-4 w-4"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"><path d="M15 18l-6-6 6-6"></path></svg
                >
              </button>
              <button
                type="button"
                aria-label="Nächster Eintrag"
                data-guestbook-next
                class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 bg-white text-slate-700 shadow-sm transition hover:-translate-y-0.5 hover:border-brand-500 hover:text-brand-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500"
              >
                <svg
                  class="h-4 w-4"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"><path d="M9 6l6 6-6 6"></path></svg
                >
              </button>
            </div>
          </div>
        </div>
        <div class="relative" data-guestbook-slider>
          <div
            class="flex gap-4 transition-transform duration-500 ease-out"
            data-guestbook-track
          >
            {
              guestbookHighlights.map((entry) => (
                <article class="min-w-0 snap-start shrink-0 grow-0 basis-full rounded-2xl border border-slate-200 bg-white p-6 shadow-xl shadow-slate-900/12 transition hover:-translate-y-1 hover:shadow-2xl md:basis-1/2 xl:basis-1/3">
                  <blockquote class="text-slate-700 dark:text-slate-300">
                    <svg
                      class="mb-3 h-6 w-6 text-brand-600"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                      aria-hidden="true"
                    >
                      <path d="M7.17 6A5 5 0 0 0 2 11v7a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-7a1 1 0 0 0-1-1H6.74a3.17 3.17 0 0 1 3-3.57 1 1 0 0 0 1-1V4.72a1 1 0 0 0-1.08-1.01A5 5 0 0 0 7.17 6Zm12 0a5 5 0 0 0-5.17 5v7a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-7a1 1 0 0 0-1-1h-2.26a3.17 3.17 0 0 1 3-3.57 1 1 0 0 0 1-1V4.72a1 1 0 0 0-1.07-1.01A5 5 0 0 0 19.17 6Z" />
                    </svg>
                    <p class="text-base leading-relaxed">{entry.message}</p>
                  </blockquote>
                  <div class="mt-4 border-t border-slate-200 pt-3 text-sm text-slate-600">
                    <div class="font-semibold text-slate-900 dark:text-white">
                      {entry.name}
                    </div>
                    <div>{entry.city}</div>
                  </div>
                </article>
              ))
            }
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="faq" class="mt-16 md:mt-24">
    <div class="container">
      <div class="mx-auto max-w-3xl text-center">
        <h2 class="heading-section">Häufig gestellte Fragen</h2>
        <p class="mt-3 text-slate-700 dark:text-slate-300">
          Alles, was Sie vor Ihrem ersten Besuch wissen müssen, kurz und bündig
          erklärt.
        </p>
      </div>
      <div class="mt-10">
        <FAQ />
      </div>
    </div>
  </section>

  <section class="mt-16 md:mt-24">
    <div class="container">
      <div
        class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between"
      >
        <div class="max-w-2xl">
          <h2 class="heading-section">Einblicke in unsere Arbeit</h2>
          <p class="mt-2 text-slate-700 dark:text-slate-300">
            Schrauben, löten, nähen und genießen – Impressionen unserer letzten
            Treffen.
          </p>
        </div>
        <a
          href="/galerie"
          class="inline-flex items-center gap-2 self-start rounded-full border border-slate-300 bg-white px-5 py-3 text-sm font-semibold text-slate-800 shadow-sm transition hover:-translate-y-0.5 hover:bg-slate-50"
        >
          Bildergalerie ansehen
          <svg
            class="h-4 w-4"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"><path d="M5 12h14M13 5l7 7-7 7"></path></svg
          >
        </a>
      </div>

      <div class="relative mt-8">
        <div
          class="no-scrollbar flex snap-x snap-mandatory gap-6 overflow-x-auto pb-4 scroll-px-4 md:scroll-px-6"
        >
          {
            highlightGallery.map((item) => (
              <figure
                class="front-gallery-item snap-center shrink-0 grow-0 basis-3/4 cursor-pointer outline-none transition focus:-translate-y-1 focus:shadow-lg sm:basis-1/2 lg:basis-1/4"
                data-image={item.image}
                data-title={item.title ?? ""}
                data-description={item.description ?? ""}
                data-alt={item.alt ?? item.title ?? ""}
                tabindex="0"
                role="button"
                aria-label={`Bild vergrößern: ${item.title ?? "Impression"}`}
              >
                <div class="group relative aspect-[3/4] overflow-hidden rounded-[2.25rem] bg-slate-200 shadow-lg shadow-slate-900/10 transition duration-500">
                  <img
                    src={item.image}
                    alt={item.alt}
                    loading="lazy"
                    class="h-full w-full scale-105 object-cover transition duration-500 group-hover:scale-110"
                  />
                  <div class="pointer-events-none absolute inset-x-0 bottom-0 h-1/2 bg-gradient-to-t from-slate-950/95 via-slate-950/35 to-transparent opacity-95 transition duration-300 group-hover:opacity-100" />
                  <figcaption class="pointer-events-none absolute inset-x-0 bottom-0 flex flex-col gap-1 rounded-b-[2.25rem] px-5 pb-4 pt-8 text-white drop-shadow-[0_12px_30px_rgba(5,5,5,0.45)] transition duration-300">
                    {item.title && (
                      <span class="card-title-sm text-white drop-shadow-[0_4px_12px_rgba(8,8,8,0.8)]">
                        {item.title}
                      </span>
                    )}
                    {item.description && (
                      <span class="text-[0.78rem] font-medium leading-snug text-white/85 drop-shadow-[0_2px_8px_rgba(0,0,0,0.85)]">
                        {item.description}
                      </span>
                    )}
                  </figcaption>
                </div>
              </figure>
            ))
          }
        </div>
      </div>
    </div>
  </section>

  <CTA />

  <Footer />

  <div
    id="front-gallery-lightbox"
    class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-950/80 p-6 backdrop-blur transition duration-300 opacity-0 pointer-events-none"
    role="dialog"
    aria-modal="true"
    aria-labelledby="front-lightbox-title"
  >
    <button
      id="front-gallery-lightbox-close"
      type="button"
      class="absolute right-6 top-6 inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/85 text-slate-800 shadow-lg shadow-slate-900/30 backdrop-blur-sm transition hover:-translate-y-0.5 hover:bg-white"
      aria-label="Galerie schließen"
    >
      <svg
        class="h-5 w-5"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"><path d="M6 6l12 12M6 18L18 6"></path></svg
      >
    </button>
    <div
      class="max-h-[90vh] w-full max-w-4xl overflow-hidden rounded-[2.25rem] border border-white/10 bg-gradient-to-b from-slate-900/90 via-slate-900/80 to-slate-950/95 shadow-2xl shadow-slate-950/60"
    >
      <div class="relative">
        <div class="flex items-center justify-center bg-slate-900">
          <img
            id="front-lightbox-image"
            src=""
            alt=""
            class="max-h-[70vh] w-full scale-95 object-contain opacity-0 transition duration-500 ease-out"
          />
        </div>
        <button
          id="front-gallery-lightbox-prev"
          type="button"
          class="absolute left-4 top-1/2 inline-flex h-12 w-12 -translate-y-1/2 items-center justify-center rounded-full bg-white/80 text-slate-800 shadow-lg shadow-slate-900/30 backdrop-blur-sm transition hover:-translate-y-[calc(50%+4px)] hover:bg-white"
          aria-label="Vorheriges Bild"
        >
          <svg
            class="h-5 w-5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"><path d="M15 6l-6 6 6 6"></path></svg
          >
        </button>
        <button
          id="front-gallery-lightbox-next"
          type="button"
          class="absolute right-4 top-1/2 inline-flex h-12 w-12 -translate-y-1/2 items-center justify-center rounded-full bg-white/80 text-slate-800 shadow-lg shadow-slate-900/30 backdrop-blur-sm transition hover:-translate-y-[calc(50%+4px)] hover:bg-white"
          aria-label="Nächstes Bild"
        >
          <svg
            class="h-5 w-5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"><path d="M9 6l6 6-6 6"></path></svg
          >
        </button>
        <div
          class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-slate-950/95 to-slate-900/10 px-6 py-6 text-center text-white backdrop-blur"
        >
          <h3
            id="front-lightbox-title"
            class="font-display text-lg font-semibold tracking-tight"
          >
            &nbsp;
          </h3>
          <p
            id="front-lightbox-description"
            class="mt-2 text-sm text-slate-200/80"
          >
            &nbsp;
          </p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    const initFrontGallery = () => {
      const frontItems = Array.from(
        document.querySelectorAll(".front-gallery-item"),
      );
      const lightbox = document.getElementById("front-gallery-lightbox");
      const lightboxImage = document.getElementById("front-lightbox-image");
      const lightboxTitle = document.getElementById("front-lightbox-title");
      const lightboxDescription = document.getElementById(
        "front-lightbox-description",
      );
      const lightboxClose = document.getElementById(
        "front-gallery-lightbox-close",
      );
      const lightboxPrev = document.getElementById(
        "front-gallery-lightbox-prev",
      );
      const lightboxNext = document.getElementById(
        "front-gallery-lightbox-next",
      );

      if (
        !frontItems.length ||
        !lightbox ||
        !lightboxImage ||
        !lightboxTitle ||
        !lightboxDescription
      ) {
        return;
      }

      let currentIndex = -1;

      const showItem = (index) => {
        const item = frontItems[index];
        if (!item) return;
        const imageSrc = item.dataset.image ?? "";
        if (!imageSrc) return;
        lightboxImage.src = imageSrc;
        lightboxImage.alt = item.dataset.alt ?? "";
        const title = item.dataset.title?.trim();
        const description = item.dataset.description?.trim();
        lightboxTitle.textContent =
          title && title.length ? title : "Impression aus dem Repair Café";
        lightboxDescription.textContent =
          description && description.length
            ? description
            : "Gemeinsam reparieren macht den Unterschied.";
        requestAnimationFrame(() => {
          lightboxImage.classList.remove("scale-95", "opacity-0");
          lightboxImage.classList.add("scale-100", "opacity-100");
        });
      };

      const openLightbox = (index) => {
        if (!frontItems[index]) return;
        currentIndex = index;
        lightboxImage.classList.remove("scale-100", "opacity-100");
        lightboxImage.classList.add("scale-95", "opacity-0");
        lightbox.classList.remove("pointer-events-none", "opacity-0");
        lightbox.classList.add("opacity-100");
        showItem(currentIndex);
        document.body.classList.add("overflow-hidden");
      };

      const closeLightbox = () => {
        lightbox.classList.add("pointer-events-none");
        lightbox.classList.remove("opacity-100");
        lightbox.classList.add("opacity-0");
        lightboxImage.classList.remove("scale-100", "opacity-100");
        lightboxImage.classList.add("scale-95", "opacity-0");
        lightboxImage.src = "";
        document.body.classList.remove("overflow-hidden");
        currentIndex = -1;
      };

      const goTo = (step) => {
        if (currentIndex === -1) return;
        const total = frontItems.length;
        currentIndex = (currentIndex + step + total) % total;
        lightboxImage.classList.remove("scale-100", "opacity-100");
        lightboxImage.classList.add("scale-95", "opacity-0");
        showItem(currentIndex);
      };

      frontItems.forEach((item, index) => {
        item.addEventListener("click", () => openLightbox(index));
        item.addEventListener("keypress", (event) => {
          if (event.key === "Enter") {
            openLightbox(index);
          }
        });
      });

      lightboxClose?.addEventListener("click", closeLightbox);
      lightbox?.addEventListener("click", (event) => {
        if (event.target === lightbox) {
          closeLightbox();
        }
      });
      window.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeLightbox();
        }
        if (event.key === "ArrowLeft" && currentIndex !== -1) {
          event.preventDefault();
          goTo(-1);
        }
        if (event.key === "ArrowRight" && currentIndex !== -1) {
          event.preventDefault();
          goTo(1);
        }
      });
      lightboxPrev?.addEventListener("click", () => goTo(-1));
      lightboxNext?.addEventListener("click", () => goTo(1));
    };

    const schedule = (fn) =>
      "requestIdleCallback" in window
        ? window.requestIdleCallback(fn)
        : window.setTimeout(fn, 0);

    if (
      document.readyState === "interactive" ||
      document.readyState === "complete"
    ) {
      schedule(initFrontGallery);
    } else {
      document.addEventListener(
        "DOMContentLoaded",
        () => {
          schedule(initFrontGallery);
        },
        { once: true },
      );
    }
  </script>
</BaseLayout>
